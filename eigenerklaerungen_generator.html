<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eigenerklärungen generieren – VergabeAssist</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Supabase‑Client für Datenabruf und -speicherung -->
  <script src="supabaseClient.js"></script>
  <!-- Skript zur Verwaltung der zusätzlichen Angaben (Laden, Speichern, Einklappen) -->
  <script src="js/eigenerklaerungen_generator.js"></script>
</head>
<body>
<header>
  <div id="burgerMenu" class="burger-menu" onclick="toggleSidebarMenu()">
    <span></span><span></span><span></span>
  </div>
  <div class="header-center">
    <a href="index.html" tabindex="0">
      <img src="img/logo_govdisrupt_ai.png" alt="GovDisrupt AI Logo" class="header-firm-logo" />
    </a>
  </div>
  <button id="loginTopBtn" class="login-top-btn" onclick="window.location.href='account.html'" aria-label="Account">
    <span class="material-icons" style="font-size:1.9em;vertical-align:middle;">account_circle</span>
    <span style="font-size:1em;margin-left:0.35em;">Account</span>
  </button>
</header>
<div id="sidebarOverlay" class="sidebar-overlay"></div>
<aside id="sidebarMenu" class="sidebar-menu-left">
  <nav class="sidebar-links">
    <a href="dashboard.html"><span class="material-icons">dashboard</span> Projekte</a>
    <a href="vorlagen.html"><span class="material-icons">collections_bookmark</span> Vorlagen</a>
    <a href="account.html"><span class="material-icons">person</span> Account</a>
  </nav>
</aside>

<!-- Hauptbereich mit voller Breite für Eigenerklärungen -->
<main class="eigenerklaerungen-main">
  <section>
    <h1>Eigenerklärungen generieren</h1>
    <p>Standardformulare ausfüllen und bereitstellen</p>

    <!-- Breadcrumb ganz oben im Main‑Bereich -->
    <nav class="breadcrumb-nav-top" style="margin-bottom:1.5rem;">
      <a href="index.html"><span class="material-icons" style="vertical-align:-0.25em;font-size:1.1em;">home</span> Startseite</a>
      <span class="breadcrumb-sep">›</span>
      <a href="dashboard.html">Dashboard</a>
      <span class="breadcrumb-sep">›</span>
      <a href="projekt.html">Projekt</a>
      <span class="breadcrumb-sep">›</span>
      <span class="breadcrumb-current">Eigenerklärungen</span>
    </nav>

    <!-- Zusätzliche Angaben zum Projekt (optional) -->
    <section class="projekt-formularexport" style="margin-bottom:2em;">
      <div class="collapsible-head" style="display:flex;align-items:center;gap:0.8em;cursor:pointer;">
        <h3 id="formExtraHead" style="margin:0;">Zusätzliche Angaben zum Projekt</h3>
        <span id="collapser" class="material-icons" style="transition:transform 0.19s;font-size:1.5em;user-select:none;">expand_less</span>
      </div>
      <div class="collapsible-content" id="formExtraContent" style="background:#eaf4fb;padding:1em 1.3em;border-radius:8px;margin-top:1em;">
        <label>
          <b>Baumaßnahme / Projekt:</b><br>
          <input type="text" id="baumaßnahmeInput" placeholder="z.B. Sanierung Turnhalle" style="width:80%;">
        </label>
        <br>
        <label>
          <b>Maßnahmenummer:</b><br>
          <input type="text" id="maßnahmeNrInput" placeholder="z.B. 2024-001" style="width:60%;">
        </label>
        <br>
        <label>
          <b>Vergabenummer:</b><br>
          <input type="text" id="vergabeNrInput" placeholder="z.B. 24-0112-03" style="width:60%;">
        </label>
        <div style="color:#4183a4;margin-top:0.7em;">
          <small>Hinweis: Diese Angaben werden später für Formblätter (z.B. VHB 124) und die automatische Formularbefüllung genutzt.<br>Sie sind <b>optional</b>, aber sehr empfohlen.</small>
        </div>
        <div style="margin-top:0.8em;">
          <button id="saveFormularFieldsBtn" style="padding:0.4em 1.3em;">Speichern</button>
          <span id="formularSaveStatus" style="color:#2a8826;font-size:1em;"></span>
        </div>
      </div>
    </section>

    <!-- Chat‑Bereich für Eigenerklärungen -->
    <section class="chat-container">
      <div class="chat-header" style="justify-content:flex-end;">
        <span class="material-icons info-icon" title="Fragen Sie nach benötigten Eigenerklärungen oder laden Sie Unterlagen hoch, um ausgefüllte Formulare zu erhalten.">info</span>
      </div>
      <div id="fileBubbleRow" class="filebubble-row"></div>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-bar">
        <textarea id="chatInput" placeholder="Welche Eigenerklärungen benötigen Sie? (z. B. Steuerehrlichkeit, Korruptionsfreiheit)" autocomplete="off"></textarea>
        <div class="chat-input-row">
          <div class="chat-upload-block">
            <label class="upload-btn" title="Datei hinzufügen">
              <span class="upload-plus">+</span>
              <input type="file" id="fileUpload" multiple />
            </label>
            <span class="upload-label">Datei auswählen</span>
          </div>
          <button id="sendBtn">Senden</button>
        </div>
      </div>
    </section>
  </section>
</main>

<footer style="display:flex;align-items:center;gap:1.4em;">
  <img src="img/logo_govdisrupt_ai.png" alt="Firmenlogo" style="height:36px;margin-right:1.4em;">
  <span style="flex:1;">
    &copy; 2025 VergabeAssistent |
    <a href="impressum.html" target="_blank">Impressum</a> |
    <a href="datenschutz.html" target="_blank">Datenschutz</a> |
    <a href="nutzungsbedingungen.html" target="_blank">Nutzungsbedingungen</a> |
    <a href="avv.html" target="_blank">AVV</a>
  </span>
</footer>

<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const fileUpload = document.getElementById('fileUpload');
const fileBubbleRow = document.getElementById('fileBubbleRow');
function appendMessage(sender, text) {
  const msg = document.createElement('div');
  msg.classList.add('message', sender);
  const bubble = document.createElement('div');
  bubble.classList.add('bubble');
  if (sender === 'assistant' && window.marked) {
    bubble.innerHTML = marked.parse(text);
  } else {
    bubble.textContent = text;
  }
  msg.appendChild(bubble);
  if (sender === 'assistant') {
    const copyBtn = document.createElement('button');
    copyBtn.classList.add('copy-btn');
    copyBtn.innerHTML = '<span class="material-icons">content_copy</span>';
    copyBtn.title = 'Antwort kopieren';
    copyBtn.onclick = () => navigator.clipboard.writeText(bubble.innerText);
    msg.appendChild(copyBtn);
  }
  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;
  appendMessage('user', text);
  chatInput.value = '';
  chatInput.focus();
  sendBtn.disabled = true;
  const loadingMsg = document.createElement('div');
  loadingMsg.classList.add('message', 'assistant');
  const loadingBubble = document.createElement('div');
  loadingBubble.classList.add('bubble');
  loadingBubble.innerHTML = '<span class="chat-hint">Analysiere …</span>';
  loadingMsg.appendChild(loadingBubble);
  chatMessages.appendChild(loadingMsg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  setTimeout(() => {
    loadingMsg.remove();
    const reply = 'Der VergabeAssistent schlägt passende Eigenerklärungen vor, lädt aktuelle Formulare herunter und füllt sie mit Ihren Daten. (Demonstration)';
    appendMessage('assistant', reply);
    sendBtn.disabled = false;
  }, 1000);
}
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
fileUpload.addEventListener('change', () => {
  fileBubbleRow.innerHTML = '';
  for (const file of fileUpload.files) {
    const fileBubble = document.createElement('div');
    fileBubble.classList.add('file-bubble');
    fileBubble.innerHTML =
      '<span class="material-icons file-icon">attach_file</span>' +
      '<span class="file-name">' + file.name + '</span>' +
      '<span class="file-type">.' + file.name.split('.').pop() + '</span>' +
      '<button type="button" class="file-remove">&times;</button>';
    fileBubbleRow.appendChild(fileBubble);
    fileBubble.querySelector('.file-remove').onclick = () => {
      fileUpload.value = '';
      fileBubbleRow.innerHTML = '';
    };
  }
});
function toggleSidebarMenu(force = false) {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  const isOpen = sidebar.classList.contains('open');
  if (isOpen || force) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    document.body.classList.add('sidebar-closed');
    sessionStorage.setItem('sidebarMenuClosed', '1');
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('active');
    document.body.classList.remove('sidebar-closed');
    sessionStorage.removeItem('sidebarMenuClosed');
    setTimeout(() => sidebar.focus && sidebar.focus(), 120);
  }
}
document.addEventListener('DOMContentLoaded', () => {
  if (!sessionStorage.getItem('sidebarMenuClosed')) {
    document.getElementById('sidebarMenu').classList.add('open');
    document.getElementById('sidebarOverlay').classList.add('active');
  } else {
    document.body.classList.add('sidebar-closed');
  }
});
document.getElementById('sidebarOverlay').onclick = () => toggleSidebarMenu(true);
document.addEventListener('keydown', e => { if (e.key === 'Escape') toggleSidebarMenu(true); });
(function() {
  let title = document.title || '';
  if (title.indexOf('–') > 0) title = title.split('–')[0].trim();
  document.getElementById('breadcrumbCurrent').textContent = title;
})();
</script>
</body>
</html>
